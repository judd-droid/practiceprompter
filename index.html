<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <link rel="preload" as="image" href="/supernovacenter.png">
  <title>Supernova Practice Prompter</title>
  <style>
    /* --------------------------------------------------
       Supernova UI tokens (match Activity Logger vibe)
    -------------------------------------------------- */
    :root{
      --sn-red:#DD467D;         /* primary accent */
      --sn-red-ink:#B83264;     /* darker accent */
      --sn-black:#111827;       /* headings */
      --sn-gray:#6b7280;        /* body text */
      --bg:#f8fafc;             /* app bg */
      --card:#ffffff;           /* cards */
      --line:#e5e7eb;           /* borders */
      --ok:#16a34a;             /* done check */
      --muted:#9ca3af;          /* disabled */
      --shadow: 0 8px 24px rgba(17,24,39,.08), 0 2px 8px rgba(17,24,39,.06);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--sn-black);
      font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    .app{max-width:520px; margin:0 auto; padding:16px 16px 90px}
    /* -------------------------------------------------- Header */
    /* Tighter header with safe-area awareness */
    .header{
      position:sticky; top:0; z-index:10;
      display:flex; flex-direction:column; align-items:center;
      gap:4px;                             /* less gap between logo/title */
      padding:calc(env(safe-area-inset-top, 0px) + 4px) 12px 6px;
      margin:0 -16px 6px;                  /* minimal space above/below */
      background:linear-gradient(#f7f9fc,#f8fafc);
      border-bottom:1px solid var(--line);
    }
    
    /* Smaller, still responsive header logo */
    .header .logo{
      display:block;
      margin:2px auto 4px;
      max-height: clamp(56px, 9vw, 84px);  /* ↓ was 96–128px */
      width:auto !important;
      height:auto !important;
      object-fit:contain;
      background:none !important;
      border:none !important;
      border-radius:0 !important;
      box-shadow:none !important;
    }
    
    /* Smaller title and no default h1 margins */
    .header h1{
      font-size:18px;                      /* “a notch” smaller if needed */
      font-weight:700;
      color:var(--sn-black);
      margin:2px 0 2px;                    /* kill big top/bottom margins */
    }
    
    /* Pull the date scroller closer to the header */
    .date-wrap{ margin:6px 0 4px; }
    
    /* If you still see space from an older wrapper around the logo/title */
    .brand{ margin:0; padding:0; }

    /* Settings button stays pinned */
    .actions{ position:absolute; right:12px; top:8px; }
    
    /* If you still need a small logo somewhere else, scope it: */
    .toolbar .logo{
      width:36px; height:36px; object-fit:contain; display:block;
      border-radius:8px; box-shadow:0 2px 6px rgba(17,24,39,.12);
    }

    .app-title{
      margin:0; font-size:16px; font-weight:800; color:var(--sn-black); letter-spacing:.2px;
    }
    /* (optional) stop using the old .brand/.badge styles */
    .brand,.badge{ display:none; }
    .brand h1{font-size:18px; margin:0}
    .badge{display:inline-block; font-size:12px; color:#fff; background:var(--sn-red); padding:2px 8px; border-radius:999px; margin-left:6px}
    .actions{margin-left:auto}
    .icon-btn{border:none; background:#fff; border:1px solid var(--line); width:36px; height:36px; border-radius:10px; display:grid; place-items:center; box-shadow:var(--shadow); cursor:pointer}
    .gear{width:18px; height:18px; color:var(--sn-gray)}
    .prospect-name{
      font-size: 1.375rem;      /* ~22px; was ~24px */
      line-height: 1.2;
    }
    @media (min-width: 768px){
      .prospect-name{ font-size: 1.75rem; } /* ~28px -> keep it modest on larger screens */
    }

    .meta-grid{
      display:grid;
      grid-template-columns: 0.8fr 2.2fr;
      gap:12px;
      margin:10px 0 2px;
    }
    .meta-card{
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      box-shadow:var(--shadow);
    }
    .meta-tag{font-size:12px; color:var(--sn-gray)}
    .meta-value{
      font-size:22px;                     /* Prospect stays large */
      font-weight:800;
      letter-spacing:.2px;
      margin-top:4px;
      word-break:break-word;
    }
    
    /* Scenario is smaller and multi-line clamped */
    #scenarioName{
      font-size: clamp(12px, 2.6vw, 14px); /* a couple of notches smaller */
      line-height: 1.35;
      font-weight: 700;
      display: -webkit-box;
      -webkit-line-clamp: 4;               /* show up to 4 lines */
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .logo{
      width:36px;
      height:36px;
      border-radius:8px;          /* use 50% if you want it circular */
      object-fit:contain;         /* keeps the PNG from stretching */
      display:block;
      box-shadow:0 2px 6px rgba(17,24,39,.12);
    }
    
    /* -------------------------------------------------- Day scroller */
    .date-wrap{margin:12px 0 4px}
    .month-row{display:flex; align-items:center; justify-content:space-between; color:var(--sn-gray); font-weight:600; font-size:14px}
    .arrow{border:none; background:transparent; color:var(--sn-gray); font-size:20px; padding:6px 10px; cursor:pointer}

    /* OLD .days rules become a viewport (no grid here) */
    .days{
      position: relative;
      overflow: hidden;
      margin-top: 8px;
    }
    
    /* Sliding rail that holds 3 week panels: prev | current | next */
    .days-track{
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: 100%;
      transition: transform .28s ease;
      will-change: transform;
    }
    
    /* Each panel is the 3 day cards for that week */
    .week{
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      padding: 0 2px;      /* tiny breathing room on edges */
    }
    
    .day{position:relative; background:var(--card); border:1px solid var(--line); border-radius:12px; padding:8px 6px 18px; text-align:center; box-shadow:var(--shadow); cursor:pointer; user-select:none}
    .day .dow{display:block; font-size:10px; color:var(--sn-gray)}
    .day .num{display:block; font-size:16px; font-weight:700}
    .day .check{position:absolute; left:50%; transform:translateX(-50%); bottom:4px; font-size:12px}
    .day.current{outline:2px solid var(--sn-red); outline-offset:2px}
    .day.past:hover{border-color:#d1d5db}
    .day.future{opacity:.5; cursor:not-allowed}
    .check.ok{color:var(--ok)}
    .check.pending{color:var(--muted)}

    /* -------------------------------------------------- Prospect badge */
    .prospect{display:flex; align-items:center; gap:10px; margin:10px 0 2px}
    .prospect .tag{font-size:12px; color:var(--sn-gray)}
    .prospect-name{font-size:22px; font-weight:800; letter-spacing:.2px}
    .chip{border:1px solid var(--line); padding:4px 10px; border-radius:999px; background:#fff; color:var(--sn-gray); font-size:12px; cursor:pointer}

    /* -------------------------------------------------- Script cards */
    .card{background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); margin:10px 0}
    .role{display:flex; align-items:center; gap:8px; font-weight:700; color:var(--sn-gray); margin-bottom:6px}
    .avatar{width:10px; height:10px; border-radius:50%}
    .avatar.prospect{background:#334155}
    .avatar.you{background:var(--sn-red)}
    .script{font-size:clamp(18px, 3.8vw, 22px); line-height:1.5; color:var(--sn-black)}
    .muted{color:var(--sn-gray)}

    .progress{display:flex; align-items:center; justify-content:space-between; color:var(--sn-gray); font-size:12px; margin-top:6px}
    .bar{height:6px; background:#f1f5f9; border-radius:999px; overflow:hidden}
    .bar > i{display:block; height:100%; background:linear-gradient(90deg, #f2a6c5, #DD467D); width:0%}

    /* -------------------------------------------------- Bottom controls */
    .dock{position:fixed; left:0; right:0; bottom:0; z-index:20; display:flex; gap:12px; padding:12px 16px; background:rgba(248,250,252,.88); backdrop-filter:saturate(180%) blur(12px); border-top:1px solid var(--line)}
    .btn{flex:1; border:none; border-radius:14px; padding:14px 12px; font-weight:700; cursor:pointer}
    .btn.secondary{background:#fff; color:var(--sn-black); border:1px solid var(--line); box-shadow:var(--shadow)}
    .btn.primary{background:var(--sn-red); color:#fff; box-shadow:0 10px 22px rgba(221,70,125,.35)}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    /* -------------------------------------------------- Modal */
    dialog{border:none; border-radius:18px; width:min(560px,92vw); padding:0; box-shadow:0 24px 56px rgba(17,24,39,.2)}
    .modal{padding:16px}
    .modal h3{margin:0 0 8px}
    .steps{max-height:50vh; overflow:auto; border:1px solid var(--line); border-radius:12px}
    .steps div{padding:10px 12px; border-bottom:1px solid var(--line); display:flex; gap:8px}
    .steps div:last-child{border-bottom:none}
    .steps .idx{font-weight:800; color:var(--sn-gray); width:28px; text-align:right}
    .modal .foot{display:flex; gap:10px; margin-top:12px}

    /* hide ugly default close marker on Safari */
    dialog::backdrop{background:rgba(0,0,0,.25)}
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <div class="header">
      <div class="actions">
        <button class="icon-btn" id="btnSettings" title="Settings / Reset" aria-label="Settings">
          <svg class="gear" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h0A1.65 1.65 0 0 0 9 3.09V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h0a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v0A1.65 1.65 0 0 0 21 9h.09a2 2 0 1 1 0 4H21a1.65 1.65 0 0 0-1.51 1z"></path>
          </svg>
        </button>
      </div>
    
      <!-- centered logo -->
      <img src="/supernovacenter.png" class="logo" alt="Supernova Center">
      <!-- plain black title -->
      <h1 class="app-title">Practice Prompter</h1>
    </div>

    <!-- Date Scroller -->
    <section class="date-wrap">
      <div class="month-row">
        <button class="arrow" id="prevWeek" aria-label="Previous">‹</button>
        <div id="monthLabel">September</div>
        <button class="arrow" id="nextWeek" aria-label="Next">›</button>
      </div>
      <div id="days" class="days" role="tablist" aria-label="Practice days"></div>
    </section>

    <!-- Prospect + Scenario (2-column) -->
    <section class="meta-grid">
      <div class="meta-card">
        <div class="meta-tag">Today’s Prospect</div>
        <div class="meta-value" id="prospectName">Benjie</div>
      </div>
      <div class="meta-card">
        <div class="meta-tag">Practice Scenario</div>
        <div class="meta-value" id="scenarioName">—</div>
      </div>
    </section>

    <!-- Scripts -->
    <div class="card" id="cardProspect" aria-live="polite">
      <div class="role"><span class="avatar prospect"></span> Prospect</div>
      <div class="script" id="lineProspect">Hello?</div>
    </div>

    <div class="card" id="cardAdvisor">
      <div class="role"><span class="avatar you"></span> You</div>
      <div class="script" id="lineAdvisor">Hi Benjie, this is Jen from AIA. Do you have a quick minute?</div>
      <div class="progress">
        <div>Step <b id="stepNow">1</b> / <b id="stepTotal">20</b></div>
        <div class="bar" aria-hidden="true"><i id="bar"></i></div>
      </div>
    </div>
  </div>

  <!-- Bottom Controls -->
  <div class="dock">
    <button class="btn secondary" id="btnBack">‹ Back</button>
    <button class="btn secondary" id="btnList">⋯ Steps</button>
    <button class="btn primary" id="btnNext">Next ›</button>
  </div>

  <!-- Steps Modal -->
  <dialog id="dlg">
    <div class="modal">
      <h3>Conversation Steps</h3>
      <div class="steps" id="stepsList"></div>
      <div class="foot">
        <button class="btn secondary" id="btnMarkDone">Mark day as Done ✓</button>
        <button class="btn primary" id="btnRestart">Replay from Step 1</button>
      </div>
    </div>
  </dialog>

  <script>
      // Your live endpoint
      const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz9OW8GWX2FHTD65r7HyDGZGf2k6szuz9AmT4SwPdPrFjWYCl1OK5KzKOvZ2vIrkHt2qQ/exec";
    
      // JSONP helper
      function fetchJSONP(url) {
        return new Promise((resolve, reject) => {
          const cb = `SNPP_CB_${Math.random().toString(36).slice(2)}`;
          const s = document.createElement('script');
          const sep = url.includes('?') ? '&' : '?';
          s.src = `${url}${sep}callback=${cb}`;
          s.async = true;
          window[cb] = (data) => { resolve(data); cleanup(); };
          s.onerror = (e) => { reject(e); cleanup(); };
          function cleanup(){ delete window[cb]; s.remove(); }
          document.head.appendChild(s);
        });
      }
    
      // SINGLE DATA object (no duplicates elsewhere in the file)
      const DATA = {
        key: 'snpp_remote_v2',
        async fetch(){
          // Force JSONP to avoid CORS
          const data = await fetchJSONP(WEB_APP_URL);
          if (!data || typeof data !== 'object') throw new Error('Bad JSONP payload');
          return data;
        },
        setLocal(obj){ localStorage.setItem(this.key, JSON.stringify(obj||{})); },
        getLocal(){ try { return JSON.parse(localStorage.getItem(this.key)||'{}'); } catch { return {}; } }
      };
    
    /* --------------------------------------------------
       Remote data loader (Google Apps Script JSON) + M/W/F UI
    -------------------------------------------------- */
    const $ = sel => document.querySelector(sel);
    const fmtISO = d => {
      // local-time YYYY-MM-DD (no UTC shift)
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    };

    const clamp = (n,min,max)=> Math.max(min, Math.min(max,n));

    const PROSPECT_NAMES = [
      'Benjie','Mara','Paolo','Ava','Rico','Shiela','Anton','Grace','Loren','JR',
      'Allan','Sandy','Gio','Migs','Kara','Dane','Rhea','Gail','Ivan','Nika'
    ];

    const cleanName = s => String(s || '').trim().replace(/^["'“”]+|["'“”]+$/g,'');

    const storage = {
      key: 'snpp_state_v3',   // <- bump to v3
      load(){ return JSON.parse(localStorage.getItem(this.key)||'{}'); },
      save(s){ localStorage.setItem(this.key, JSON.stringify(s)); },
    };

    // Parse "YYYY-MM-DD" into a LOCAL date (no UTC shift)
    const parseISO = (iso) => { const [y,m,d] = iso.split('-').map(Number); return new Date(y, m-1, d); };

    // Week helpers (M/W/F only)
    const monIndex = d => (d.getDay()+6)%7; // Monday=0..Sunday=6
    const startOfWeekMon = d => { const s=new Date(d); s.setHours(0,0,0,0); s.setDate(s.getDate()-monIndex(s)); return s; };
    const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
    const sameDay = (a,b)=> fmtISO(a)===fmtISO(b);
    const isMWF = d => [1,3,5].includes(d.getDay()); // Mon=1, Wed=3, Fri=5
    const nearestOf = (d, arr)=> arr.reduce((best,curr)=> Math.abs(curr-d)<Math.abs(best-d)?curr:best, arr[0]);
    const weekStart = (d) => startOfWeekMon(atMidnight(d));

    // Fallback local script bank (only used if remote missing for a date)
    const FALLBACK = [
      { p:'Hello?', a:'Hi {PROSPECT}, this is from AIA. Do you have a quick minute? (today or tomorrow evening?)' },
      {p:'What is this about?', a:'I help families set up affordable protection and health plans. Can I share a quick overview?'},
      {p:'I already have insurance.', a:'Great! When was your last review? We can check if everything still fits—30 mins lang.'},
      {p:'Busy ako ngayon.', a:'I get it. Would Friday or Saturday work better? (morning or evening?)'},
      {p:'Friday evening.', a:'Perfect—let’s lock Friday 7 PM via Zoom. I’ll send the link after this call.'},
      {p:'Sige.', a:'Thanks! Agenda: (1) your goals, (2) key concepts, (3) next steps. About 30 minutes.'},
      {p:'Okay, game.', a:'Kumusta! I noticed your bike sa background—mahilig ka ba mag‑cycling?'},
      {p:'Oo.', a:'I help with 4 areas: life, health care, education, and retirement. Which is top priority today?'},
      {p:'Medical costs worry me.', a:'Got it. A dedicated health fund avoids touching savings. Target between ₱1M–₱10M—what feels right?'},
      {p:'Maybe ₱2M.', a:'Noted. What coverage do you already have (HMO/CI)?'},
      {p:'HMO lang.', a:'So the gap is near ₱2M minus HMO. Let me show a plan that pays a lump sum on diagnosis—focus on recovery.'},
      {p:'How does it work?', a:'Think of it as your family’s airbag—cash when you need it most; premiums fit your budget.'},
      {p:'Magkano per month?', a:'If we keep it within ₱3k/mo, would you be comfortable?'},
      {p:'Medyo mataas.', a:'We can start lower and step up later. What range feels right today?'},
      {p:'₱2k.', a:'We can structure at ₱2k with CI rider. Okay to include your spouse in the discussion?'},
      {p:'Just send the details.', a:'Happy to send, but it may not answer all questions. Let’s do a 15‑min walk‑through—today PM or tomorrow AM?'},
      {p:'Tomorrow AM.', a:'Great. Before we wrap: on a scale of 1–10, how comfortable are you so far?'},
      {p:'Mga 7.', a:'What would make it a 10? (so I can tailor the plan precisely)'},
      {p:'Flexible payment options.', a:'If we arrange quarterly at no extra cost, are you happy to proceed? Which mode suits you—auto‑debit, card, or OTC?'},
      {p:'Auto‑debit works. Proceed na.', a:'Awesome—I’ll prep the application and send the Zoom invite. Thank you, {PROSPECT}!'}
    ];

    const atMidnight = (d) => { const x = new Date(d); x.setHours(0,0,0,0); return x; };
    const todayLocal = () => atMidnight(new Date());
    const isFutureDate = (d) => atMidnight(d).getTime() > todayLocal().getTime();
    
    function snapMWF(d){
      const base = atMidnight(d);
      const sw = startOfWeekMon(base);
      const opts = [sw, addDays(sw,2), addDays(sw,4)];
      // pick absolute nearest
      return opts.reduce((best,curr)=> Math.abs(curr-base) < Math.abs(best-base) ? curr : best, opts[0]);
    }
    
    /** Select a date but never allow future days. If target week is fully future,
     *  clamp to the latest allowed day (or today). Always return an M/W/F. */
    function selectSafe(date){
      let t = snapMWF(date);
      if (isFutureDate(t)) {
        const sw = startOfWeekMon(t);
        const candidates = [sw, addDays(sw,2), addDays(sw,4)].filter(x => !isFutureDate(x));
        t = candidates.length ? candidates[candidates.length-1] : todayLocal();
        t = snapMWF(t); // ensure M/W/F even after clamping
      }
      return atMidnight(t);
    }

    function template(str, prospect){
      const out = String(str || '')
        .replaceAll('{PROSPECT}', prospect || '')
        .replaceAll('{ADVISOR}', '')                 // strip advisor token if it appears
        .replace(/\s{2,}/g, ' ')                     // collapse double spaces
        .replace(/\s+([,.;:!?])/g, '$1')             // trim space before punctuation
        .trim();
      return out;
    }

    // Treat rows like "—", "--", "___" or blank as empty
    function isNullishCell(v) {
      const t = String(v ?? '').trim();
      return !t || /^[-–—_]+$/.test(t);
    }
    
    function cleanSteps(arr) {
      const steps = Array.isArray(arr) ? arr : [];
      // keep rows where either P or A has real content
      return steps.filter(s => !(isNullishCell(s.p) && isNullishCell(s.a)));
    }

    const app = {
      state: { advisor:'Jen', selected: new Date(), daily:{} },
      remote: {},
      async init(){
        const saved = storage.load();
        this.state = Object.assign({ advisor:'Jen', selected: new Date(), daily:{} }, saved);
        
        // Load remote JSON → hydrate
        try {
          const json = await DATA.fetch();
          DATA.setLocal(json);
          this.remote = json;
        } catch(err){
          this.remote = DATA.getLocal();
        }
        this.hydrateFromRemote();
        
        // Pick a real date from the sheet (not future). Prefer saved selection; else today; else earliest.
        const prefer = this.state.selected || new Date();
        const picked = this.nearestValidNotAfter(prefer) || this.nearestValidNotAfter(new Date());
        this.state.selected = picked || todayLocal();  // last resort: today (will show "Locked – future" if needed)
        
        this.renderWeek();
        this.bind();
        this.renderScripts();
      },
      hydrateFromRemote(){
        // remote: { 'YYYY-MM-DD': { prospect, steps:[{p,a}] } }
        this.validSet = new Set();      // fast membership check by ISO string
        this.validDates = [];           // Date[] (local midnight), sorted asc
      
        const src = this.remote || {};
        Object.keys(src).forEach(iso => {
          const rec = src[iso] || {};
          this.validSet.add(iso);
          this.validDates.push(atMidnight(parseISO(iso)));
      
          if (!this.state.daily[iso]) {
            this.state.daily[iso] = {
              prospect: (rec.prospect && String(rec.prospect).trim())
                ? String(rec.prospect).trim()
                : 'Prospect',
              step: 1,
              done: false
            };
          }
          // Lock sheet name & attach steps
          if (rec.prospect && String(rec.prospect).trim()){
            this.state.daily[iso].prospect = String(rec.prospect).trim();
            this.state.daily[iso]._lockedProspect = true;
          }
          
          // NEW: attach scenario text (if present)
          if (rec.scenario && String(rec.scenario).trim()){
            this.state.daily[iso].scenario = String(rec.scenario).trim();
          }
          
          this.state.daily[iso]._steps = cleanSteps(rec.steps);

          // If the saved step is now out of range (because we trimmed),
          // pull it back to the last valid step
          const max = this.state.daily[iso]._steps.length || 1;
          this.state.daily[iso].step = Math.min(this.state.daily[iso].step || 1, max);
        });
      
        // sort and keep only non-future for navigation
        this.validDates.sort((a,b)=> a - b);
        this.validPastDates = this.validDates.filter(d => !isFutureDate(d));
      
        storage.save(this.state);
      },
      nearestValidNotAfter(date){
        const t = +atMidnight(date);
        let pick = null;
        for (const d of this.validPastDates) {
          const ms = +d;
          if (ms <= t) pick = d; else break;
        }
        // if none <= t, pick earliest available
        return pick || this.validPastDates[0] || null;
      },
      prevValid(date){
        const t = +atMidnight(date);
        let prev = null;
        for (const d of this.validPastDates) {
          const ms = +d;
          if (ms < t) prev = d; else if (ms === t) break; else break;
        }
        return prev;
      },
      nextValid(date){
        const t = +atMidnight(date);
        for (const d of this.validPastDates) {
          const ms = +d;
          if (ms > t) return d;
        }
        return null;
      },

      randName(){ return PROSPECT_NAMES[(Math.random()*PROSPECT_NAMES.length) | 0]; },
      get day(){ return this.state.daily[fmtISO(this.state.selected)]; },
      currentSteps(){
        const d = this.day; const steps = (d && d._steps && d._steps.length)? d._steps : FALLBACK;
        return steps;
      },
      setStep(n){
        const max = this.currentSteps().length;
        this.day.step = clamp(n,1,max);
        if(this.day.step===max) this.day.done=true;
        storage.save(this.state);
        this.renderScripts();
        this.renderWeek();
      },
      bind(){
        $('#btnBack').addEventListener('click', ()=> this.setStep(this.day.step-1));
        $('#btnNext').addEventListener('click', ()=> this.setStep(this.day.step+1));
        $('#btnList').addEventListener('click', ()=> $('#dlg').showModal());
        $('#btnRestart').addEventListener('click', ()=>{ this.setStep(1); $('#dlg').close(); });
        $('#btnMarkDone').addEventListener('click', ()=>{
          this.day.done = true;
          this.day.step = this.currentSteps().length;
          storage.save(this.state);
          this.renderScripts();
          this.renderWeek(); // ← was renderDays()
          $('#dlg').close();
        });
        $('#btnSettings').addEventListener('click', () => {
          if (confirm('Reset local progress?')) { localStorage.clear(); location.reload(); }
        });
      
        // arrows → slide
        $('#prevWeek').addEventListener('click', () => this.slideWeek(-1));
        $('#nextWeek').addEventListener('click', () => this.slideWeek(1));
      
        // swipe → slide
        (() => {
          const area = document.querySelector('.date-wrap');
          if (!area) return;
          const THRESH_X = 40, LIMIT_Y = 60;
          let sx=0, sy=0, tracking=false;
          const start = (x,y)=>{ sx=x; sy=y; tracking=true; };
          const end   = (x,y)=>{
            if(!tracking) return; tracking=false;
            const dx=x-sx, dy=y-sy;
            if(Math.abs(dx)>THRESH_X && Math.abs(dy)<LIMIT_Y){
              if(dx<0) this.slideWeek(1); else this.slideWeek(-1);
            }
          };
          area.addEventListener('touchstart', e=> start(e.touches[0].clientX, e.touches[0].clientY), {passive:true});
          area.addEventListener('touchend',   e=> end(e.changedTouches[0].clientX, e.changedTouches[0].clientY), {passive:true});
          area.addEventListener('pointerdown', e=> start(e.clientX, e.clientY));
          area.addEventListener('pointerup',   e=> end(e.clientX, e.clientY));
        })();
      }
      
      // Swipe → slide (reuse your existing detector, just call slideWeek)
      (function enableWeekSwipe(){
        const area = document.querySelector('.date-wrap');
        if (!area) return;
        const THRESH_X = 40, LIMIT_Y = 60;
        let sx=0, sy=0, tracking=false;
      
        const start = (x,y)=>{ sx=x; sy=y; tracking=true; };
        const end   = (x,y)=>{
          if(!tracking) return; tracking=false;
          const dx=x-sx, dy=y-sy;
          if(Math.abs(dx)>THRESH_X && Math.abs(dy)<LIMIT_Y){
            if(dx<0) app.slideWeek(1); else app.slideWeek(-1);
          }
        };
        area.addEventListener('touchstart', e=> start(e.touches[0].clientX, e.touches[0].clientY), {passive:true});
        area.addEventListener('touchend',   e=> end(e.changedTouches[0].clientX, e.changedTouches[0].clientY), {passive:true});
        area.addEventListener('pointerdown', e=> start(e.clientX, e.clientY));
        area.addEventListener('pointerup',   e=> end(e.clientX, e.clientY));
      })();

      },
      snapToMWF(){ if(!isMWF(this.state.selected)){ const sw=startOfWeekMon(this.state.selected); const opts=[sw, addDays(sw,2), addDays(sw,4)]; this.state.selected = nearestOf(this.state.selected, opts); } },
      
      renderWeek(){
        const d = this.state.selected;
        const month = d.toLocaleDateString(undefined,{month:'long', year:'numeric'});
        $('#monthLabel').textContent = month;
        this.renderDaysStrip();
      },
      
      renderDaysStrip(){
        const wrap = $('#days');
        wrap.innerHTML = '';
        const track = document.createElement('div');
        track.id = 'daysTrack';
        track.className = 'days-track';
        wrap.appendChild(track);
      
        const curStart  = weekStart(this.state.selected);
        const prevStart = addDays(curStart, -7);
        const nextStart = addDays(curStart,  7);
      
        track.appendChild(this.buildWeekPanel(prevStart));
        track.appendChild(this.buildWeekPanel(curStart));
        track.appendChild(this.buildWeekPanel(nextStart));
      
        track.style.transition = 'none';
        track.style.transform  = 'translateX(-100%)';
        requestAnimationFrame(()=> track.style.transition = 'transform .28s ease');
      },
      
      buildWeekPanel(startDate){
        const panel = document.createElement('div');
        panel.className = 'week';
        [0,2,4].forEach(off=>{
          const t = addDays(startDate, off);
          const key = fmtISO(t);
          const hasData  = this.validSet && this.validSet.has(key);
          const isFuture = isFutureDate(t);
          const disabled = !hasData || isFuture;
          const isCurrent= sameDay(t, this.state.selected);
          const done     = hasData && this.state.daily[key] && this.state.daily[key].done;
      
          const el = document.createElement('button');
          el.className = 'day ' + (disabled?'future':'past') + (isCurrent?' current':'');
          el.innerHTML = `
            <span class="dow">${t.toLocaleDateString(undefined,{weekday:'short'})}</span>
            <span class="num">${t.getDate()}</span>
            <span class="check ${done?'ok':'pending'}">${done?'✓':''}</span>
          `;
          if (!disabled) {
            el.onclick = () => {
              this.state.selected = t;
              storage.save(this.state);
              this.renderWeek(); this.renderScripts();
            };
          }
          panel.appendChild(el);
        });
        return panel;
      },
      
      slideWeek(dir){
        const track = document.getElementById('daysTrack');
        if (!track) return;
      
        const candidate = addDays(this.state.selected, dir*7);
        const allowed   = this.nearestValidNotAfter(candidate);
      
        if (!allowed || fmtISO(allowed) === fmtISO(this.state.selected)) {
          track.style.transition = 'transform .15s ease';
          track.style.transform  = `translateX(${dir===1?-110:-90}%)`;
          setTimeout(()=>{
            track.style.transition = 'transform .15s ease';
            track.style.transform  = 'translateX(-100%)';
          }, 140);
          return;
        }
      
        track.style.transform = `translateX(${dir===1?-200:0}%)`;
        track.addEventListener('transitionend', () => {
          this.state.selected = allowed;
          storage.save(this.state);
          this.renderWeek();
          this.renderScripts();
        }, { once:true });
      },

      renderScripts(){
        const key = fmtISO(this.state.selected);
        const d = this.state.daily[key];
        const sel = atMidnight(this.state.selected);

        // If the date has no data in the sheet, show a friendly lock
        if (!this.validSet || !this.validSet.has(key)) {
          $('#prospectName').textContent = '“No script for this date”';
          $('#lineProspect').textContent = 'There’s no practice script in the Sheet for this day.';
          $('#lineAdvisor').textContent  = '';
          $('#stepNow').textContent = '–';
          $('#bar').style.width = '0%';
          $('#btnBack').disabled = true;
          $('#btnNext').disabled = true;
          $('#stepsList').innerHTML = '';
          return;
        }
      
        if (isFutureDate(sel)) {
          $('#prospectName').textContent = '“Locked – future date”';
          $('#lineProspect').textContent = 'This practice script unlocks on that date.';
          $('#lineAdvisor').textContent  = '';
          $('#stepNow').textContent = '–';
          $('#bar').style.width = '0%';
          $('#btnBack').disabled = true;
          $('#btnNext').disabled = true;
          $('#stepsList').innerHTML = '';
          return;
        }

        $('#prospectName').textContent = `${d.prospect}`;
        $('#scenarioName').textContent = d.scenario?.trim() || '—';
        $('#scenarioName').title = d.scenario || '';
        
        $('#prospectName').textContent = cleanName(d.prospect);
        
        const steps = this.currentSteps();
        
        // Handle case where, after trimming, there are no steps
        if (!steps.length) {
          $('#prospectName').textContent = d.prospect;
          $('#lineProspect').textContent = 'No practice lines for this date.';
          $('#lineAdvisor').textContent  = '';
          $('#stepNow').textContent = '0';
          $('#stepTotal').textContent = '0';
          $('#bar').style.width = '0%';
          $('#btnBack').disabled = true;
          $('#btnNext').disabled = true;
          $('#stepsList').innerHTML = '';
          return;
        }
        
        // Make sure current step never exceeds the new length
        if (d.step > steps.length) { d.step = steps.length; storage.save(this.state); }
        
        const pair = expandFromArray(steps, d.step, d.prospect, this.state.advisor||'Jen');
        $('#lineProspect').textContent = pair.p || '—';
        $('#lineAdvisor').textContent  = pair.a || '—';
        
        $('#stepNow').textContent   = d.step;
        $('#stepTotal').textContent = steps.length;
        
        const pct = (d.step-1)/Math.max(1,(steps.length-1))*100;
        $('#bar').style.width = pct+'%';
        
        $('#btnBack').disabled = d.step <= 1;
        $('#btnNext').disabled = d.step >= steps.length;

        const list = $('#stepsList'); 
        list.innerHTML = '';
        steps.forEach((s, idx) => {
          const e = document.createElement('div');
          e.innerHTML = `<span class="idx">${idx+1}</span><span><b>P:</b> ${template(s.p, d.prospect)}<br><b>You:</b> ${template(s.a, d.prospect)}</span>`;
          e.addEventListener('click', () => { this.setStep(idx+1); $('#dlg').close(); });
          list.appendChild(e);
        });
        
        // Lock/disable Shuffle when name comes from sheet
        const locked = !!d._lockedProspect;
        const shuffleBtn = document.getElementById('shuffleProspect');
      }
    };

    function expandFromArray(arr, idx, prospect){
      const s = arr[idx-1] || {p:'', a:''};
      return { p: template(s.p, prospect), a: template(s.a, prospect) };
    }

    // Boot
    app.init();
    window.__snpp = app;

  </script>
</body>
</html>
